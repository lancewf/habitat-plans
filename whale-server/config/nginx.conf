daemon off;
pid {{pkg.svc_var_path}}/pid;

worker_processes  {{cfg.worker_processes}};
worker_rlimit_nofile {{cfg.worker_rlimit_nofile}};

events {
    worker_connections  {{cfg.events.worker_connections}};
}

http {
    client_body_temp_path {{pkg.svc_var_path}}/nginx/client-body;
    fastcgi_temp_path {{pkg.svc_var_path}}/nginx/fastcgi;
    proxy_temp_path {{pkg.svc_var_path}}/nginx/proxy;
    scgi_temp_path {{pkg.svc_var_path}}/nginx/scgi_temp_path;
    uwsgi_temp_path {{pkg.svc_var_path}}/nginx/uwsgi;

    include        {{pkgPathFor "core/nginx"}}/config/mime.types;
    default_type   application/octet-stream;

    sendfile       {{cfg.http.sendfile}};
    tcp_nopush     {{cfg.http.tcp_nopush}};
    tcp_nodelay    {{cfg.http.tcp_nodelay}};

    keepalive_timeout  {{cfg.http.keepalive_timeout}};

    gzip  on;
    gzip_vary on;
    gzip_min_length 10240;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;
    gzip_disable "MSIE [1-6]\.";

{{~#eachAlive bind.mmsn.members as |mmsn|}}
{{~#if @last}}
    server {
          listen 80;
          listen [::]:80;

          server_name {{cfg.mmsn.domain_name}};

          client_max_body_size 100M;

          location / {
            {{#if mmsn.cfg.local_only ~}}
            proxy_pass http://127.0.0.1:{{mmsn.cfg.port}};
            {{else ~}}
            proxy_pass http://{{mmsn.sys.ip}}:{{mmsn.cfg.port}};
            {{/if ~}}
            
            proxy_redirect     off;
            proxy_set_header   Host $host;
          }
    }
{{~/if}}
{{~/eachAlive}}

{{~#eachAlive bind.money-checker-server.members as |mcs|}}
{{~#if @last}}
    server {
          listen 80;
          listen [::]:80;

          server_name {{cfg.money-checker-server.domain_name}};

          client_max_body_size 100M;

          location / {
            {{#if mcs.cfg.local_only ~}}
            proxy_pass http://127.0.0.1:{{mcs.cfg.port}};
            {{else ~}}
            proxy_pass http://{{mcs.sys.ip}}:{{mcs.cfg.port}};
            {{/if ~}}
            
            proxy_redirect     off;
            proxy_set_header   Host $host;
          }
    }
{{~/if}}
{{~/eachAlive}}

{{~#eachAlive bind.wiki.members as |wiki|}}
{{~#if @last}}
    server {
          listen 80;
          listen [::]:80;

          server_name {{cfg.wiki.domain_name}};

          client_max_body_size 100M;

          location / {
            {{#if wiki.cfg.local_only ~}}
            proxy_pass http://127.0.0.1:{{wiki.cfg.port}};
            {{else ~}}
            proxy_pass http://{{wiki.sys.ip}}:{{wiki.cfg.port}};
            {{/if ~}}

            proxy_redirect     off;
            proxy_set_header   Host $host;
          }
    }
}
{{~/if}}
{{~/eachAlive}}

{{~#eachAlive bind.hawaii-alaska-whale-dis.members as |hawaii-alaska-whale-dis|}}
{{~#if @last}}
    server {
          listen 80;
          listen [::]:80;

          server_name {{cfg.hawaii-alaska-whale-dis.domain_name}};

          client_max_body_size 100M;

          location / {
            {{#if hawaii-alaska-whale-dis.cfg.local_only ~}}
            proxy_pass http://127.0.0.1:{{hawaii-alaska-whale-dis.cfg.port}};
            {{else ~}}
            proxy_pass http://{{hawaii-alaska-whale-dis.sys.ip}}:{{hawaii-alaska-whale-dis.cfg.port}};
            {{/if ~}}

            proxy_redirect     off;
            proxy_set_header   Host $host;
          }
    }
}
{{~/if}}
{{~/eachAlive}}

{{~#eachAlive bind.media-whale-dis.members as |media-whale-dis|}}
{{~#if @last}}
    server {
          listen 80;
          listen [::]:80;

          server_name {{cfg.media-whale-dis.domain_name}};

          client_max_body_size 100M;

          location / {
            {{#if media-whale-dis.cfg.local_only ~}}
            proxy_pass http://127.0.0.1:{{media-whale-dis.cfg.port}};
            {{else ~}}
            proxy_pass http://{{media-whale-dis.sys.ip}}:{{media-whale-dis.cfg.port}};
            {{/if ~}}

            proxy_redirect     off;
            proxy_set_header   Host $host;
          }
    }
}
{{~/if}}
{{~/eachAlive}}

{{~#eachAlive bind.west-coast-whale-dis.members as |west-coast-whale-dis|}}
{{~#if @last}}
    server {
          listen 80;
          listen [::]:80;

          server_name {{cfg.west-coast-whale-dis.domain_name}};

          client_max_body_size 100M;

          location / {
            {{#if west-coast-whale-dis.cfg.local_only ~}}
            proxy_pass http://127.0.0.1:{{west-coast-whale-dis.cfg.port}};
            {{else ~}}
            proxy_pass http://{{west-coast-whale-dis.sys.ip}}:{{west-coast-whale-dis.cfg.port}};
            {{/if ~}}

            proxy_redirect     off;
            proxy_set_header   Host $host;
          }
    }
}
{{~/if}}
{{~/eachAlive}}

{{~#eachAlive bind.pacific-northwest-whale-dis.members as |pacific-northwest-whale-dis|}}
{{~#if @last}}
    server {
          listen 80;
          listen [::]:80;

          server_name {{cfg.pacific-northwest-whale-dis.domain_name}};

          client_max_body_size 100M;

          location / {
            {{#if pacific-northwest-whale-dis.cfg.local_only ~}}
            proxy_pass http://127.0.0.1:{{pacific-northwest-whale-dis.cfg.port}};
            {{else ~}}
            proxy_pass http://{{pacific-northwest-whale-dis.sys.ip}}:{{pacific-northwest-whale-dis.cfg.port}};
            {{/if ~}}

            proxy_redirect     off;
            proxy_set_header   Host $host;
          }
    }
}
{{~/if}}
{{~/eachAlive}}

{{~#eachAlive bind.west-coast-training-whale-dis.members as |west-coast-training-whale-dis|}}
{{~#if @last}}
    server {
          listen 80;
          listen [::]:80;

          server_name {{cfg.west-coast-training-whale-dis.domain_name}};

          client_max_body_size 100M;

          location / {
            {{#if west-coast-training-whale-discfg.local_only ~}}
            proxy_pass http://127.0.0.1:{{west-coast-training-whale-dis.cfg.port}};
            {{else ~}}
            proxy_pass http://{{west-coast-training-whale-dis.sys.ip}}:{{west-coast-training-whale-dis.cfg.port}};
            {{/if ~}}

            proxy_redirect     off;
            proxy_set_header   Host $host;
          }
    }
}
{{~/if}}
{{~/eachAlive}}
